## API

- [x] **API 协议**

  协议：UART（TTY）
  波特率：115200
  校验位：无或奇校验或偶校验
  数据位：8
  停止位：1
  有无换行位：无 BOM
  接收终止位：无
  发送终止位：1 位 `char` 类型的字符 `E`

- [x] **基础 API**
- 单片机向树莓派发送 1 位 `char` 类型数据
  - 发送 `1` 开始第一次最大颜色区域识别
  - 发送 `2` 开始第二次最大颜色区域识别
- 树莓派向单片机发送 1 位 `char` 类型数据
  - 发送最大面积颜色区域的数字标号，不需要返回值
  - 无发送终止位
- [x] **高级 API**
- 单片机向树莓派发送 1 位 `char` 类型数据
  - 发送字符 `1` 开始第一次最大颜色区域识别
  - 发送字符 `2` 开始第二次最大颜色区域识别
  - 发送字符 `3` 控制小车从当前位置到色球放置区 1
  - 发送字符 `4` 实时追踪小球位置并调整小车位置
  - 发送字符 `5` 控制小车从当前位置到色球放置区 2
  - 发送字符 `6` 实时追踪小球位置并调整小车位置
  - 发送字符 `7` 控制小车从当前位置到终点
  - 发送随机的一位或多位字符，对于需要返回值的指令，即表明该指令操作完成
- 树莓派向单片机发送多位 `char` 类型数据
  - 调整摄像头角度（需要在完成调整后反馈随机的一位或多位字符）
    - 第一位字符为 `C`
    - 第二位起字符为需要摄像头与水平面夹角的正角度数字（可能包括 1~3 位字符）

示例：摄像头视野与水平面垂直，面向正前方->`C90`

   - 设置停止十字标记数（需要在到达设置的十字标记后反馈随机的一位或多位字符）
     - 第一位字符为 `L`
     - 第二位字符为小车移动方向，向前为 `U`，向后为 `B`
     - 第三位字符为十字标记数，表示在移动方向上，数到第几个十字标记停下来（包括 1 位字符）

示例：从当前位置向前在第 3 个十字标记处停车->`LU3`

   - 视觉巡线调整小车姿态（不需要反馈，只有当小车偏离循迹线一定距离或角度后发送，渐近式调整）
     - 第一位字符为 M
     - 第二位字符为小车移动方向，由小车车身中心与循迹线垂直距离差决定，向左为 `L`，向右为 `R`
     - 第三位字符为小车旋转方向，由小车车身轴线与循迹线角度差决定，向左为 `L`，向右为 `R`
     - 第四位起到分隔位的字符为移动方向的偏离值数字(>0)，是小车车身中心与循迹线垂直距离的差，单位 px，用于位置偏离幅度参考（可能包括 2~3 位字符）
     - 分隔位为字符 `:`，对于不确定的数据长度中数字的分割
     - 从分隔位起的字符为旋转方向的偏离值数字(>0)，是小车在视觉 ROI 区域内的循迹线首末端点的横坐标之差，间接反映小车车身轴线与循迹线角度大小，单位 px，用于旋转偏离幅度参考（可能包括 2~3 位字符）

示例：在当前运动状态下，小车车身向左移动一单位，偏离幅度为 34，小车向右旋转一单位，旋转幅度为100->`MLR34:100`

   - 小球追踪（需要在成功抓取小球后反馈随机的一位或多位字符，只有当小球偏离准星一定距离后发送，渐近式调整）
     - 第一位字符为 `B`
     - 第二位字符为小球偏离水平方向，由准星与小球中心的水平座标差决定，偏左为 `L`，偏右为 `R`
     - 第三位字符为小球偏离垂直方向，由准星与小球中心的竖直座标差决定，偏上为 `U`，偏下为`D`
     - 第四位起到分隔位的字符为水平偏离值数字(>0)，是准星与小球中心的水平座标的差，单位 px，用于水平偏离幅度参考（可能包括 2~4 位字符）
     - 分隔位为字符 `:`，对于不确定的数据长度中数字的分割
     - 从分隔位起的字符为垂直偏离值数字(>0)，是准星与小球中心的竖直座标的差，单位 px，用于垂直幅度参考（可能包括 2~4 位字符）

示例：在当前运动状态下，小球相对准星右偏，偏离幅度为 114，小球相对准星下偏，偏离幅度为 514->`BRD114:514`


- 树莓派向单片机发送一位 `char` 类型的终止位
  - 每次树莓派向单片机通过_高级 API_ 进行串口通讯时，会在发送完所有位数据后再发送一位终止位
  - 终止位是 1 位 `char` 类型的字符 `E`，标志着该次数据发送完毕
  - 当单片机接收一个或多个 `char` 后，如果当前读取到的 `char` 的值是终止位，则立即清空串口缓冲区，结束读取并开始处理读取到的数据

示例：摄像头视野与水平面垂直，面向正前方->`C90`，再加一位终止位后，单片机实际接收到的数据为->`C90E`

## 流程设计

#### 基于基础 API

   1. 小车位于起点处，摄像头正对屏幕。准备就绪后单片机向树莓派发送 `1` 开启第一次最大面积颜色区域识别
   2. 树莓派完成第一次识别，向单片机返回最大面积颜色标号如 `2`，单片机控制小车以循迹线十字标记为准，到达相应颜色位置并执行开锁
   3. 开锁后小车返回循迹线或停留在开锁区域循迹线十字标记处，摄像头正对屏幕，单片机向树莓派发送 `2` 开启第二次最大面积颜色区域识别
   4. 树莓派完成第二次识别，向单片机返回最大面积颜色标号如 `1`，单片机控制小车以循迹线十字标记为准，到达相应颜色位置并执行开锁
   5. 完成开锁任务

#### 基于高级 API 的标准流程

   1. 小车位于起点处，准备就绪后单片机向树莓派发送 `1` 开启第一次最大面积颜色区域识别
   2. 树莓派向单片机发送 `C90`，调整摄像头角度与水平面垂直，正对屏幕
   3. 单片机完成摄像头角度调整后，反馈随机的一位或多位字符
   4. 树莓派收到反馈，开启颜色识别。完成识别后，如最大面积颜色所在位置为前方的第 2 个的十字标记，向单片机发送 `LU2`
   5. 单片机收到指令，在光电巡线下到达前方十字标记 2，控制小车进行第一次开锁
   6. 完成开锁后小车返回循迹线或停留在开锁区域循迹线十字标记处，单片机向树莓派发送 `2` 开启第二次最大面积颜色区域识别
   7. 树莓派向单片机发送 `C90`，调整摄像头角度与水平面垂直，正对屏幕
   8. 单片机完成摄像头角度调整后，反馈随机的一位或多位字符
   9. 树莓派收到反馈，开启颜色识别。完成识别后，如最大面积颜色的位置在当前十字标记后方 1 个距离的十字标记处，向单片机发送 `LD1`
   10. 单片机收到指令，在光电巡线下后退 1 个十字标记，到达最大面积颜色开锁区域，控制小车进行第二次开锁
   11. 完成开锁任务

#### 基于高级 API 的标准流程

   - 包括颜色识别与开锁，视觉巡线，色球追踪。不包括具体离开开锁区域十字标记后的小车运动控制，完成开锁后小车返回十字标记处的运动控制（如果需要离开循迹线开锁），抓取小球时的小车和小车机械装置的运动控制，抓取小球后小车返回循迹线十字标记处的运动控制和循迹线第一个直角拐角处的小车转向控制。参照视觉组文件夹中 `/src/main.cpp`。
